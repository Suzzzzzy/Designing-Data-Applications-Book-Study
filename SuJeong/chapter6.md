# 6. 파티셔닝 


## 1. 파티셔닝 : 대용량 데이터베이스를 의도적으로 작은 단위로 쪼개는 방법
- 파티션을 나눌 때 보통 각 데이터 단위가 하나의 파티션에 속하게 한다.

## 2. 대용량 데이터 파티셔닝
- 목적
  - 확장성
    - 대용량 데이터셋이 여러 디스크에 분산될 수 있고 질의 부하는 여러 프로세서에 분산될 수 있다.
  - 파티셔닝의 목적은 데이터와 질의 부하를 노드 사이에 고르게 분산

## 3. 키-값 데이터 파티셔닝
- 키 - 값 데이터 모델을 사용하여 기본키를 통해 레코드에 접근
- skewed : 파티셔닝이 고르게 이뤄지지 않아서 다른 파티션보다 데이터가 많거나 질의를 많이 받는 파티션이 있는 경우
- 핫스팟 : 불균형하게 부하가 높은 파티션
- 핫스팟 피할 수 있는 방법은 레코드 할당 노드를 무작위로 선택하여 노드에 고르게 분산하는것이나, 어떤 레코드를 읽을때 해당 레코드가 어느 노드에 저장되었는지 알 수 없어 모든 노드에서 병렬적으로 질의 실행 필요
## 4. 키 범위 기준 파티셔닝
- 데이터를 고르게 분산시키려면 파티션 경계를 데이터에 맞춰 조정해야 한다.
- 각 파티션 내에서는 키를 정렬된 순서로 저장할 수 있다.
- key 범위 기준 파티셔닝은 특정한 접근 패턴이 핫스팟을 유발하는 단점이 있음

## 5. 키의 해시값 기준 파티셔닝

- 쏠림, 핫스팟 위험으로 → 해시함수를 사용해서 키의 파티션 정함
- 입력 문자열이 거의 유사해도 해시값은 숫자 범위 내에서 균일하게 분산
- 키에 적합한 해시 함수 구하기 → 각 파티션에 키 범위가 아닌 해시값 범위 할당하고 해시값이 파티션의 범위에 속하는 모든 키를 그 파티션에 할당
- 키를 파티션 사이에 균일하게 분산시키는 데 좋다고 할 수 있으나 파티셔닝에 키의 해시값을 사용해서 파티셔닝 시 키 범위 파티셔닝의 좋은 속성을 잃어 버린다.

   #일관성 해싱

   CDN(content delivery network) 같은 인터넷 규모의 캐시 시스템에서 부하 균등 분산 방법

## 6. 쏠린 작업부하와 핫스팟 완화

- 키 해싱하여 파티션 설정시 핫스팟이 줄어 들 수 있음
- 요청이 매우 많이 생기는 키를 발견 시 각 키의 시작 또는 끝에 임의의 숫자를 붙일것

## 7. 파티셔닝과 보조 색인
- 보조 색인은 레코드를 유일하게 식별하는 용도가 아니라 특정한 값이 발생한 항목을 검색하는 수단
- 문서 기준 보조 색인 파티셔닝
- 특정 조건이 같은 데이터가 같은 파티션에 저장될 확신은 없음 따라서 모든 파티션으로 질의를 보내야함
- 스캐터/개더 : 모든 파티션으로 질의를 보냄

## 8. 용어 기준 보조 색인 파티셔닝

- 각 파티션이 자신만의 보조 색인(지역 색인)을 갖게 하는 대신, 모든 파티션의 데이터를 담당하는 전역 색인을 만들 수도 있다.
- 한 노드에만 색인을 저장하면 해당 노드가 병목이 되어 파티셔닝의 목적을 해칠 수 있음
- 읽기가 효율적
- 원하는 용어를 포함하는 파티션으로만 요청을 보냄
- 전역 색인은 쓰기가 복잡하고 느림

## 9. 파티션 재균형화
- 변화
질의 처리량이 증가해서 늘어난 부하를 처리하기 위해 CPU 처리 필요성 및 다른 장비 필요 및 데이터 셋 저장에 사용할 디스크, 램 추가 필요성
- 재균형화 (rebalancing) : 클러스터에서 한 노드가 담당하던 부하를 다른 노드로 옮기는 과정

## 10. 재균형화 전략
- 파티션을 노드에 할당 방법
- 부정적 : 해시값에 모드 N 연산 실행
- nod N 방식의 문제는 노드 개수 N 이 바뀌면 대부분의 키가 노드 사이에 옮겨져야 한다는 것 nod 계산을 하면서 자주 키가 이동하고 재균형화 비용이 지나치게 커짐
- 파티션 갯수 고정
- 파티션을 노드 대수보다 많이 만들고 각 녿에 여러 파티션 할당
- 클러스터에 노드가 추가시 새 노드는 파티션이 다시 균일하게 분배될 때까지 기존 노드에서 파티션 가져올 수 있음
- 파티션은 노드 사이에서 통째로 이동
- 파티션 갯수도 바뀌지 않고 파티션에 할당된 키도 변경되지 않으며 노드에 어떤 파티션이 할당될 것인가만 변한다.

## 11. 동적 파티셔닝
- 키 범위 파티셔닝 사용 데이터베이스에서 파티션 경계와 개수가 고정되면 파티션 경계를 잘못 설정시 쏠림현상이 발생 할 수 있다.

     → 파티션 경계를 동적으로 만듬

- 파티션 크기가 커지면 (설정값보다) 두개로 쪼개고 데이터가 많이 삭제되어 값이 적어질때는 다른 인접한 파티션과 합침
- 파티션 개수가 전체 데이터 용량에 맞춰 조정됨
- 사전분할(pre-splitting)을 통해 초기 파티션을 나눠서 사용 가능
- 파티션 분할과 병합을 통해 개별 파티션 크기가 어떤 고정된 최솟값과 최댓값 사이에 유지되게 하므로 파티션 갯수가 데이터셋 크기에 비례
- 파티션 개수를 고정하면 개별 파티션의 크기가 데이터셋 크기에 비례
- 노드 대수와 독립적

## 12. 노드 비례 파티셔닝
- 파티션 개수가 노드 대수에 비례하게
- 노드당 할당되는 파티션 개수를 고정
- 노드 대수가 동일할때 개별 파티션 크기가 데이터셋 크기에 비례해서 증가, 노드 대수를 늘리면 파티션 크기는 다시 작아짐

## 13. 운영 : 자동 재균형화와 수동 재균형화
- 완전 자동 재균형화 : 관리자 개입 없이 시스템이 자동으로 파티션 노드 이동을 결정
- 완전 수동 재균형화 : 관리자가 명시적으로 파티션을 노드에 할당
- 중간지점 : 자동으로 파티션 할당 제안하지만 반영되려면 관리자가 확정 필요 

## 14.요청 라우팅
- 고가용성(여러 장비에서 이중화 설정이 된 상태로 실행되는)을 지향하는 소프트웨어에서 문제

## 15.  병렬 질의 실행